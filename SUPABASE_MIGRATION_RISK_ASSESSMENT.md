# Airtable 到 Supabase 遷移 - 風險與時程評估

## 一、程式碼品質分析

### 1.1 現有程式碼複雜度

#### 高複雜度模組
- **`lib/airtable/orders.ts` (595 行)**
  - `createOrder()` 函數：多步驟業務邏輯，包含：
    - 客戶建立/更新
    - 庫存驗證與計算
    - 訂單主檔建立
    - 訂單明細建立（循環）
    - 庫存扣減
    - 客戶統計更新
    - 狀態歷程記錄
  - **關鍵問題**：沒有真正的 Transaction 保護
  - **錯誤處理**：大量 Airtable 特定錯誤處理（約 200+ 行）
  - **Debug Logging**：大量的 agent log（開發期間的除錯代碼）

#### 中複雜度模組
- **`lib/airtable/products.ts` (267 行)**
  - 包含資料類型轉換邏輯（中文字串 → enum）
  - 錯誤處理相對簡單

- **`lib/airtable/customers.ts` (130 行)**
  - 簡單的 CRUD 操作
  - 包含 upsert 邏輯

### 1.2 程式碼品質指標

| 指標 | 評分 | 說明 |
|------|------|------|
| **錯誤處理完整性** | ⭐⭐⭐⭐ | 有詳細的錯誤訊息和處理邏輯 |
| **資料驗證** | ⭐⭐⭐⭐⭐ | 使用 Zod Schema 驗證 |
| **業務邏輯清晰度** | ⭐⭐⭐ | 邏輯正確但較複雜 |
| **Transaction 完整性** | ⭐⭐ | 沒有真正的 Transaction，可能有資料不一致風險 |
| **可測試性** | ⭐⭐ | 沒有單元測試，直接依賴 Airtable API |
| **程式碼重複** | ⭐⭐⭐ | 格式轉換邏輯在多處重複 |

## 二、遷移風險評估

### 2.1 高風險項目

#### 🔴 風險 1：Transaction 邏輯遷移
- **風險等級**：高
- **風險描述**：
  - Airtable 沒有真正的 Transaction
  - 現有程式碼依賴順序操作（沒有 rollback）
  - Supabase 使用 PostgreSQL Transaction，需要重寫邏輯
- **影響範圍**：`createOrder()` 函數
- **緩解策略**：
  1. 使用 PostgreSQL RPC Function 處理 Transaction
  2. 在資料庫層實現完整的 ACID 保證
  3. 詳細測試所有邊界情況（庫存不足、客戶建立失敗等）

#### 🔴 風險 2：錯誤處理不一致
- **風險等級**：高
- **風險描述**：
  - 現有程式碼有大量 Airtable 特定錯誤處理（422, 403, 404 等）
  - PostgreSQL 錯誤代碼完全不同（23505, 23503, 23514 等）
  - 錯誤訊息格式不同
- **影響範圍**：所有資料存取函數
- **緩解策略**：
  1. 建立統一的錯誤處理層
  2. 將 PostgreSQL 錯誤代碼轉換為使用者友善的錯誤訊息
  3. 保留詳細的錯誤日誌（用於除錯）

#### 🔴 風險 3：資料類型轉換邏輯移除
- **風險等級**：中-高
- **風險描述**：
  - 現有程式碼有中文字串 → enum 的轉換邏輯（`formatPickupMethod`, `formatPaymentMethod`, `formatGrindOption`）
  - 移除這些轉換後，可能影響前端或 API 相容性
- **影響範圍**：`lib/utils/format.ts`, 所有使用這些函數的地方
- **緩解策略**：
  1. 確認前端和 API 使用 enum 值（而非中文字串）
  2. 如果前端使用中文，需要加入轉換層
  3. 在移除前進行完整測試

### 2.2 中風險項目

#### 🟡 風險 4：JOIN 查詢複雜度
- **風險等級**：中
- **風險描述**：
  - Airtable 使用 Linked Records（在 API 層處理）
  - Supabase 需要使用 JOIN 查詢
  - 查詢效能需要優化
- **影響範圍**：`getOrders()`, `getOrderById()` 等查詢函數
- **緩解策略**：
  1. 使用 Supabase 的 `.select()` 自動處理 JOIN
  2. 建立適當的索引
  3. 進行查詢效能測試

#### 🟡 風險 5：認證系統整合
- **風險等級**：中
- **風險描述**：
  - 需要整合 Supabase Auth
  - 需要保護管理後台 API
  - 需要實作 Session 管理
- **影響範圍**：所有管理 API、後台頁面
- **緩解策略**：
  1. 使用 Supabase 官方 Next.js Auth Helpers
  2. 建立認證中間層
  3. 逐步實作（先保護 API，再保護頁面）

### 2.3 低風險項目

#### 🟢 風險 6：基本 CRUD 操作
- **風險等級**：低
- **風險描述**：Products 和 Customers 的基本操作相對簡單
- **影響範圍**：`products.ts`, `customers.ts` 的大部分函數
- **緩解策略**：直接遷移，重點測試

#### 🟢 風險 7：環境變數和設定
- **風險等級**：低
- **風險描述**：只需要更新環境變數
- **影響範圍**：`.env.local`, 部署設定
- **緩解策略**：文件化，逐步遷移

## 三、時程評估

### 3.1 詳細時程估算

| 階段 | 任務 | 估算時間 | 風險調整 | 備註 |
|------|------|----------|----------|------|
| **階段一** | Supabase 環境準備 | 1-2 天 | +0.5 天 | 包含 Migration 編寫和測試 |
| | - 建立 Supabase 專案 | 0.5 天 | | |
| | - 編寫 Migration 腳本 | 1 天 | +0.5 天 | 包含索引、觸發器、ENUM |
| | - 執行 Migration 並驗證 | 0.5 天 | | |
| **階段二** | Supabase Client 設定 | 0.5 天 | +0 天 | 相對簡單 |
| | - 安裝依賴 | 0.25 天 | | |
| | - 建立 Client | 0.25 天 | | |
| **階段三** | RPC Functions 開發 | 3-4 天 | +1 天 | **高風險，需要額外時間** |
| | - `create_order_with_items` Function | 2 天 | +1 天 | 複雜的 Transaction 邏輯 |
| | - 測試和除錯 | 1-2 天 | | |
| **階段四** | 資料存取層重寫 | 5-7 天 | +2 天 | **高風險** |
| | - `products.ts` | 1 天 | | |
| | - `customers.ts` | 1 天 | | |
| | - `orders.ts` (查詢函數) | 1-2 天 | +0.5 天 | JOIN 查詢複雜 |
| | - `orders.ts` (createOrder 使用 RPC) | 1 天 | | |
| | - 錯誤處理統一化 | 1-2 天 | +1 天 | **需要重寫錯誤處理邏輯** |
| | - 清理格式轉換函數 | 0.5 天 | +0.5 天 | 需要確認前端相容性 |
| **階段五** | 認證系統整合 | 2-3 天 | +1 天 | **中風險** |
| | - 建立 `auth.ts` | 1 天 | | |
| | - 保護 API 路由 | 1 天 | +0.5 天 | |
| | - 保護後台頁面 | 0.5 天 | +0.5 天 | |
| | - 建立登入頁面 | 0.5 天 | | |
| **階段六** | 測試與驗證 | 4-6 天 | +2 天 | **關鍵階段** |
| | - 單元測試（手動） | 2 天 | +1 天 | 沒有自動化測試框架 |
| | - 整合測試 | 1-2 天 | +0.5 天 | |
| | - 錯誤情況測試 | 1-2 天 | +0.5 天 | 測試 Transaction rollback |
| **階段七** | 清理與文件 | 1-2 天 | +0.5 天 | |
| | - 移除 Airtable 程式碼 | 0.5 天 | | |
| | - 更新文件 | 1 天 | +0.5 天 | |
| **階段八** | 部署準備 | 1 天 | +0.5 天 | |
| | - 環境變數設定 | 0.5 天 | | |
| | - 部署測試 | 0.5 天 | +0.5 天 | |

### 3.2 總時程估算

| 項目 | 樂觀估算 | 現實估算 | 悲觀估算 |
|------|----------|----------|----------|
| **基礎時程** | 17.5 天 | 22 天 | 27 天 |
| **風險緩衝** | +5 天 | +7 天 | +10 天 |
| **總計** | **22.5 天** | **29 天** | **37 天** |

**建議時程**：**4-5 週**（考慮週末和可能的突發問題）

### 3.3 關鍵路徑

關鍵路徑（Critical Path）：
1. **Supabase 環境準備** → **RPC Functions 開發** → **資料存取層重寫** → **測試與驗證**

任何一個關鍵路徑延遲都會影響整體時程。

## 四、品質保證策略

### 4.1 程式碼品質維持策略

#### ✅ 策略 1：保留現有錯誤處理品質
- **目標**：維持詳細的錯誤訊息
- **方法**：
  1. 建立 `lib/supabase/errors.ts` 統一錯誤處理
  2. 將 PostgreSQL 錯誤代碼映射到使用者友善的訊息
  3. 保留錯誤日誌（但移除開發用的 agent log）

#### ✅ 策略 2：增強 Transaction 安全性
- **目標**：提升資料一致性
- **方法**：
  1. 使用 PostgreSQL RPC Function 處理 Transaction
  2. 在資料庫層實現完整的 ACID 保證
  3. 這實際上**提升了**程式碼品質（相較於現有的無 Transaction 設計）

#### ✅ 策略 3：簡化程式碼結構
- **目標**：移除不必要的複雜度
- **方法**：
  1. 移除 Airtable 格式轉換邏輯（簡化）
  2. 使用 ENUM 類型（資料庫層驗證）
  3. 移除開發用的 agent log（清理程式碼）

#### ✅ 策略 4：改善查詢效能
- **目標**：維持或提升查詢效能
- **方法**：
  1. 使用適當的索引
  2. 使用 Supabase 的自動 JOIN 優化
  3. 進行效能測試和優化

### 4.2 測試策略

#### 單元測試（手動）
- **Products API**：建立、讀取、更新、庫存扣減
- **Customers API**：建立、查詢、更新統計
- **Orders API**：查詢、狀態更新

#### 整合測試
- **完整訂單流程**：
  1. 建立訂單（多商品）
  2. 驗證庫存扣減
  3. 驗證客戶統計更新
  4. 驗證狀態歷程記錄
  5. 測試錯誤情況（庫存不足、商品不存在等）

#### Transaction 測試
- **測試 Transaction Rollback**：
  1. 模擬庫存不足情況
  2. 驗證所有資料都正確回滾
  3. 驗證沒有部分建立的訂單

### 4.3 程式碼審查檢查清單

- [ ] 所有錯誤都有適當的處理和訊息
- [ ] Transaction 邏輯正確（使用 RPC Function）
- [ ] 查詢有適當的索引
- [ ] 認證保護已實作
- [ ] 移除所有 Airtable 特定程式碼
- [ ] 移除開發用的 agent log
- [ ] 文件已更新

## 五、風險緩解建議

### 5.1 分階段遷移（建議）

考慮到風險和時程，建議採用**分階段遷移**策略：

#### 階段 A：基礎設施準備（1 週）
- Supabase 環境設定
- Migration 腳本編寫和測試
- RPC Functions 開發和測試

#### 階段 B：資料存取層遷移（1.5 週）
- Products 和 Customers（低風險，先做）
- Orders 查詢函數
- Orders 建立函數（使用 RPC）

#### 階段 C：認證和整合（1 週）
- 認證系統整合
- API 路由更新
- 後台頁面保護

#### 階段 D：測試和部署（1-1.5 週）
- 完整測試
- 文件更新
- 部署

### 5.2 降低風險的具體措施

1. **Transaction 邏輯**：
   - 先在測試環境完整測試 RPC Function
   - 編寫詳細的測試案例（包含所有錯誤情況）
   - 進行壓力測試（並發訂單建立）

2. **錯誤處理**：
   - 建立錯誤處理對照表（Airtable → PostgreSQL）
   - 先實作基本錯誤處理，再逐步完善
   - 保留詳細的錯誤日誌（用於除錯）

3. **相容性**：
   - 確認前端使用 enum 值（而非中文字串）
   - 如果前端使用中文，加入轉換層（臨時方案）
   - 逐步移除格式轉換函數

4. **測試**：
   - 建立測試資料庫
   - 編寫測試腳本（自動化測試）
   - 進行完整的手動測試

## 六、結論與建議

### 6.1 品質評估結論

**可以保持原程式品質，甚至有所提升**：

✅ **優勢**：
- Transaction 安全性提升（使用 PostgreSQL Transaction）
- 程式碼簡化（移除 Airtable 特定邏輯）
- 錯誤處理可以保持同等品質（需要重寫但可以做到）
- 查詢效能可以優化（使用適當的索引）

⚠️ **挑戰**：
- 需要重寫錯誤處理邏輯（但可以保持同等品質）
- Transaction 邏輯需要重新設計（但實際上更安全）
- 測試需要較長時間（確保品質）

### 6.2 時程建議

**現實時程**：**4-5 週**

- **樂觀情況**：3-4 週（如果一切順利）
- **現實情況**：4-5 週（考慮風險和測試）
- **悲觀情況**：5-6 週（如果有重大問題需要解決）

### 6.3 風險等級

**整體風險等級**：**中-高**

- 技術風險：中（Supabase 是成熟的技術）
- 業務風險：中（需要充分測試）
- 時程風險：中（有足夠的緩衝時間）

### 6.4 最終建議

1. **建議進行遷移**：Supabase 提供更好的 Transaction 支援、效能和擴展性
2. **採用分階段遷移**：降低風險，便於測試和驗證
3. **重視測試階段**：這是確保品質的關鍵
4. **保留足夠的緩衝時間**：建議 4-5 週，不要壓縮時程

