{
  "name": "å’–å•¡è±†è¨‚å–®ç³»çµ± - æ–°è¨‚å–®é€šçŸ¥",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "new-order",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook - æ–°è¨‚å–®",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "jsCode": "// æ–°è¨‚å–®éƒµä»¶è™•ç† JavaScript\n// æ­¤ç¨‹å¼ç¢¼è™•ç†å¾ webhook æ¥æ”¶çš„è¨‚å–®è³‡æ–™ï¼Œä¸¦æ ¼å¼åŒ–ç‚ºéƒµä»¶å…§å®¹\n\nconst order = $input.first().json;\n\n// æ ¼å¼åŒ–è¨‚å–®é …ç›®ç‚º HTML è¡¨æ ¼è¡Œ\nconst formatOrderItems = (items) => {\n  if (!items || items.length === 0) {\n    return '<tr><td colspan=\"4\" style=\"text-align: center; padding: 15px;\">ç„¡å•†å“è³‡è¨Š</td></tr>';\n  }\n  \n  return items.map(item => `\n    <tr>\n      <td style=\"padding: 12px; border-bottom: 1px solid #e5e7eb;\">${item.product_name}</td>\n      <td style=\"padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center;\">${item.grind_option || 'åŸè±†'}</td>\n      <td style=\"padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center;\">${item.quantity}</td>\n      <td style=\"padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: right;\">NT$ ${item.unit_price.toLocaleString()}</td>\n    </tr>\n  `).join('');\n};\n\n// æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“\nconst formatDateTime = () => {\n  const now = new Date();\n  const options = {\n    timeZone: 'Asia/Taipei',\n    year: 'numeric',\n    month: '2-digit',\n    day: '2-digit',\n    hour: '2-digit',\n    minute: '2-digit'\n  };\n  return now.toLocaleString('zh-TW', options);\n};\n\n// ç”Ÿæˆéƒµä»¶ HTML å…§å®¹\nconst generateEmailHtml = (order) => {\n  return `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>è¨‚å–®ç¢ºèª - ${order.order_id}</title>\n</head>\n<body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f9fafb;\">\n  \n  <!-- æ¨™é¡Œå€å¡Š -->\n  <div style=\"background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;\">\n    <h1 style=\"color: white; margin: 0; font-size: 28px;\">â˜• è¨‚å–®ç¢ºèª</h1>\n    <p style=\"color: rgba(255,255,255,0.9); margin: 10px 0 0 0;\">æ„Ÿè¬æ‚¨çš„è¨‚è³¼ï¼</p>\n  </div>\n  \n  <!-- ä¸»è¦å…§å®¹å€å¡Š -->\n  <div style=\"background: white; padding: 30px; border-radius: 0 0 10px 10px; border: 1px solid #e5e7eb; border-top: none;\">\n    \n    <!-- è¨‚å–®ç·¨è™Ÿ -->\n    <div style=\"background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; margin-bottom: 25px; border-radius: 4px;\">\n      <p style=\"margin: 0; font-size: 14px; color: #92400e;\">è¨‚å–®ç·¨è™Ÿ</p>\n      <p style=\"margin: 5px 0 0 0; font-size: 20px; font-weight: bold; color: #78350f;\">${order.order_id}</p>\n    </div>\n    \n    <!-- è¨‚å–®ç‹€æ…‹ -->\n    <div style=\"text-align: center; margin-bottom: 25px;\">\n      <span style=\"background: #dcfce7; color: #166534; padding: 8px 20px; border-radius: 20px; font-size: 14px; font-weight: 500;\">âœ“ è¨‚å–®å·²æˆç«‹</span>\n    </div>\n    \n    <!-- å®¢æˆ¶è³‡è¨Š -->\n    <h3 style=\"color: #1f2937; border-bottom: 2px solid #f59e0b; padding-bottom: 10px; margin-top: 25px;\">ğŸ“‹ è¨‚è³¼äººè³‡è¨Š</h3>\n    <table style=\"width: 100%; margin-bottom: 20px;\">\n      <tr>\n        <td style=\"padding: 8px 0; color: #6b7280; width: 30%;\">å§“åï¼š</td>\n        <td style=\"padding: 8px 0; font-weight: 500;\">${order.customer_name}</td>\n      </tr>\n      <tr>\n        <td style=\"padding: 8px 0; color: #6b7280;\">é›»è©±ï¼š</td>\n        <td style=\"padding: 8px 0;\">${order.customer_phone}</td>\n      </tr>\n      <tr>\n        <td style=\"padding: 8px 0; color: #6b7280;\">Emailï¼š</td>\n        <td style=\"padding: 8px 0;\">${order.customer_email}</td>\n      </tr>\n      <tr>\n        <td style=\"padding: 8px 0; color: #6b7280;\">å–ä»¶æ–¹å¼ï¼š</td>\n        <td style=\"padding: 8px 0;\">${order.pickup_method}</td>\n      </tr>\n      <tr>\n        <td style=\"padding: 8px 0; color: #6b7280;\">ä»˜æ¬¾æ–¹å¼ï¼š</td>\n        <td style=\"padding: 8px 0;\">${order.payment_method}</td>\n      </tr>\n    </table>\n    \n    <!-- è¨‚å–®æ˜ç´° -->\n    <h3 style=\"color: #1f2937; border-bottom: 2px solid #f59e0b; padding-bottom: 10px; margin-top: 25px;\">ğŸ›’ è¨‚å–®æ˜ç´°</h3>\n    <table style=\"width: 100%; border-collapse: collapse; margin-bottom: 20px;\">\n      <thead>\n        <tr style=\"background: #f3f4f6;\">\n          <th style=\"padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;\">å•†å“åç¨±</th>\n          <th style=\"padding: 12px; text-align: center; border-bottom: 2px solid #e5e7eb;\">ç ”ç£¨æ–¹å¼</th>\n          <th style=\"padding: 12px; text-align: center; border-bottom: 2px solid #e5e7eb;\">æ•¸é‡</th>\n          <th style=\"padding: 12px; text-align: right; border-bottom: 2px solid #e5e7eb;\">å–®åƒ¹</th>\n        </tr>\n      </thead>\n      <tbody>\n        ${formatOrderItems(order.order_items)}\n      </tbody>\n    </table>\n    \n    <!-- é‡‘é¡æ˜ç´° -->\n    <div style=\"background: #f9fafb; padding: 20px; border-radius: 8px; margin-top: 20px;\">\n      <table style=\"width: 100%;\">\n        <tr>\n          <td style=\"padding: 8px 0; color: #6b7280;\">å•†å“å°è¨ˆï¼š</td>\n          <td style=\"padding: 8px 0; text-align: right;\">NT$ ${order.total_amount.toLocaleString()}</td>\n        </tr>\n        ${order.discount_amount && order.discount_amount > 0 ? `\n        <tr>\n          <td style=\"padding: 8px 0; color: #dc2626;\">æŠ˜æ‰£å„ªæƒ ï¼š</td>\n          <td style=\"padding: 8px 0; text-align: right; color: #dc2626;\">-NT$ ${order.discount_amount.toLocaleString()}</td>\n        </tr>\n        ` : ''}\n        <tr style=\"border-top: 2px solid #f59e0b;\">\n          <td style=\"padding: 15px 0 8px 0; font-size: 18px; font-weight: bold; color: #1f2937;\">æ‡‰ä»˜é‡‘é¡ï¼š</td>\n          <td style=\"padding: 15px 0 8px 0; text-align: right; font-size: 24px; font-weight: bold; color: #f59e0b;\">NT$ ${order.final_amount.toLocaleString()}</td>\n        </tr>\n      </table>\n    </div>\n    \n    <!-- å‚™è¨» -->\n    ${order.notes ? `\n    <div style=\"margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px;\">\n      <p style=\"margin: 0; color: #92400e;\"><strong>ğŸ“ å‚™è¨»ï¼š</strong></p>\n      <p style=\"margin: 5px 0 0 0; color: #78350f;\">${order.notes}</p>\n    </div>\n    ` : ''}\n    \n    <!-- å¾ŒçºŒæ­¥é©Ÿ -->\n    <div style=\"margin-top: 30px; padding: 20px; background: #ecfdf5; border-radius: 8px;\">\n      <h4 style=\"margin: 0 0 15px 0; color: #065f46;\">ğŸ“ å¾ŒçºŒæ­¥é©Ÿ</h4>\n      <ol style=\"margin: 0; padding-left: 20px; color: #047857;\">\n        ${order.pickup_method === 'å®…é…' ? `\n        <li style=\"margin-bottom: 8px;\">æˆ‘å€‘å°‡ç›¡å¿«è™•ç†æ‚¨çš„è¨‚å–®</li>\n        <li style=\"margin-bottom: 8px;\">å•†å“æº–å‚™å®Œæˆå¾Œæœƒä»¥é›»è©±æˆ– Email é€šçŸ¥æ‚¨</li>\n        <li style=\"margin-bottom: 8px;\">å®…é…å•†å“é è¨ˆ 2-3 å€‹å·¥ä½œå¤©é€é”</li>\n        ` : `\n        <li style=\"margin-bottom: 8px;\">æˆ‘å€‘å°‡ç›¡å¿«è™•ç†æ‚¨çš„è¨‚å–®</li>\n        <li style=\"margin-bottom: 8px;\">å•†å“æº–å‚™å®Œæˆå¾Œæœƒä»¥é›»è©±æˆ– Email é€šçŸ¥æ‚¨</li>\n        <li style=\"margin-bottom: 8px;\">è«‹æ–¼ç‡Ÿæ¥­æ™‚é–“å…§è‡³åº—é¢å–è²¨</li>\n        `}\n      </ol>\n    </div>\n    \n  </div>\n  \n  <!-- é å°¾ -->\n  <div style=\"text-align: center; margin-top: 30px; color: #9ca3af; font-size: 12px;\">\n    <p>æ­¤ç‚ºç³»çµ±è‡ªå‹•ç™¼é€çš„ä¿¡ä»¶ï¼Œè«‹å‹¿ç›´æ¥å›è¦†ã€‚</p>\n    <p>å¦‚æœ‰ä»»ä½•å•é¡Œï¼Œè«‹è¯ç¹«å®¢æœã€‚</p>\n    <p style=\"margin-top: 15px;\">Â© 2024 å’–å•¡è±†è¨‚å–®ç³»çµ± - ç”¨å¿ƒçƒ˜ç„™ï¼Œå“å‘³ç”Ÿæ´»</p>\n  </div>\n  \n</body>\n</html>\n`;\n};\n\n// ç”Ÿæˆç´”æ–‡å­—ç‰ˆæœ¬ï¼ˆå‚™ç”¨ï¼‰\nconst generatePlainText = (order) => {\n  const itemsList = order.order_items?.map(item => \n    `  - ${item.product_name} (${item.grind_option || 'åŸè±†'}) x${item.quantity} = NT$${item.unit_price}`\n  ).join('\\n') || '  ç„¡å•†å“è³‡è¨Š';\n  \n  return `\nâ˜• è¨‚å–®ç¢ºèªé€šçŸ¥\n================\n\nè¨‚å–®ç·¨è™Ÿ: ${order.order_id}\nè¨‚å–®æ™‚é–“: ${formatDateTime()}\n\nğŸ“‹ è¨‚è³¼äººè³‡è¨Š\n--------------\nå§“å: ${order.customer_name}\né›»è©±: ${order.customer_phone}\nEmail: ${order.customer_email}\nå–ä»¶æ–¹å¼: ${order.pickup_method}\nä»˜æ¬¾æ–¹å¼: ${order.payment_method}\n\nğŸ›’ è¨‚å–®æ˜ç´°\n--------------\n${itemsList}\n\nğŸ’° é‡‘é¡\n--------------\nå•†å“å°è¨ˆ: NT$ ${order.total_amount.toLocaleString()}\n${order.discount_amount && order.discount_amount > 0 ? `æŠ˜æ‰£å„ªæƒ : -NT$ ${order.discount_amount.toLocaleString()}\\n` : ''}æ‡‰ä»˜é‡‘é¡: NT$ ${order.final_amount.toLocaleString()}\n\n${order.notes ? `ğŸ“ å‚™è¨»: ${order.notes}\\n` : ''}\n\næ„Ÿè¬æ‚¨çš„è¨‚è³¼ï¼\nå’–å•¡è±†è¨‚å–®ç³»çµ±\n`;\n};\n\n// è¼¸å‡ºè™•ç†å¾Œçš„è³‡æ–™\nreturn {\n  to: order.customer_email,\n  subject: `[è¨‚å–®ç¢ºèª] ${order.order_id} - å’–å•¡è±†è¨‚å–®ç³»çµ±`,\n  html: generateEmailHtml(order),\n  text: generatePlainText(order),\n  order_id: order.order_id,\n  customer_name: order.customer_name,\n  customer_email: order.customer_email,\n  final_amount: order.final_amount\n};"
      },
      "id": "code-format-email",
      "name": "Code - æ ¼å¼åŒ–éƒµä»¶å…§å®¹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "fromEmail": "noreply@qwerboy.com",
        "toEmail": "={{ $json.to }}",
        "subject": "={{ $json.subject }}",
        "emailType": "html",
        "html": "={{ $json.html }}",
        "options": {
          "replyTo": "noreply@qwerboy.com"
        }
      },
      "id": "send-email",
      "name": "Send Email - ç™¼é€è¨‚å–®ç¢ºèª",
      "type": "n8n-nodes-base.sendEmail",
      "typeVersion": 2,
      "position": [650, 300],
      "credentials": {
        "smtp": {
          "id": "YOUR_SMTP_CREDENTIAL_ID",
          "name": "Resend SMTP"
        }
      }
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "success"
            },
            {
              "name": "message",
              "value": "=è¨‚å–® {{ $json.order_id }} ç¢ºèªéƒµä»¶å·²ç™¼é€è‡³ {{ $json.customer_email }}"
            }
          ]
        },
        "options": {}
      },
      "id": "set-response",
      "name": "Set - è¨­å®šå›æ‡‰",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [850, 300]
    }
  ],
  "connections": {
    "Webhook - æ–°è¨‚å–®": {
      "main": [
        [
          {
            "node": "Code - æ ¼å¼åŒ–éƒµä»¶å…§å®¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - æ ¼å¼åŒ–éƒµä»¶å…§å®¹": {
      "main": [
        [
          {
            "node": "Send Email - ç™¼é€è¨‚å–®ç¢ºèª",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Email - ç™¼é€è¨‚å–®ç¢ºèª": {
      "main": [
        [
          {
            "node": "Set - è¨­å®šå›æ‡‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1",
  "id": "new-order-email-workflow",
  "meta": {
    "instanceId": "coffee-order-platform"
  },
  "tags": [
    {
      "name": "è¨‚å–®é€šçŸ¥",
      "createdAt": "2026-01-05T00:00:00.000Z"
    }
  ]
}




